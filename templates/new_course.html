<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='icon.png') }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Create New Course - O.L.E.G.</title>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-left">
            <button class="btn-back" onclick="window.location.href='/'">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
                <span>Back to Courses</span>
            </button>
            <div class="nav-title">
                <h1>Create New Course</h1>
                <p>Tell OLEG what you want to learn</p>
            </div>
        </div>
        <button class="btn-finish" id="finishButton">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Finish Course
        </button>
    </nav>

    <!-- Chat Wrapper -->
    <div class="chat-wrapper">
        <div class="chat-container">
            <!-- Messages Area -->
            <div class="messages-area" id="messagesArea">
                <div class="message-group bot-group">
                    <div class="message-avatar">
                        <img src="{{ url_for('static', filename='icon.png') }}" alt="OLEG">
                    </div>
                    <div class="message-content">
                        <div class="message-bubble bot-message">
                            Hi! I'm OLEG, your AI learning assistant. First, choose your study plan duration:
                        </div>
                        <div class="duration-selector">
                            <button class="duration-btn" data-weeks="4">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                                </svg>
                                <span class="duration-label">4 Weeks</span>
                                <span class="duration-desc">Quick Start</span>
                            </button>
                            <button class="duration-btn" data-weeks="8">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                                </svg>
                                <span class="duration-label">8 Weeks</span>
                                <span class="duration-desc">Balanced</span>
                            </button>
                            <button class="duration-btn active" data-weeks="20">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                                </svg>
                                <span class="duration-label">20 Weeks</span>
                                <span class="duration-desc">Comprehensive</span>
                            </button>
                        </div>
                        <div class="message-bubble bot-message" id="duration-confirm" style="display: none;">
                            Great! Now tell me what you want to learn. For example: "I want to learn Machine Learning" or "Help me master Python programming".
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <button class="btn-attach" id="attachButton" title="Upload PDF materials (optional)">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                    <input type="text" id="userInput" placeholder="Tell me what you want to learn..." autocomplete="off">
                    <button class="btn-send" id="sendButton">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                        </svg>
                    </button>
                </div>
                <p class="input-hint">Tip: You can upload PDF materials to help OLEG understand what you want to learn</p>
            </div>
        </div>
    </div>

    <script>
        let selectedDuration = 20; // Default 20 weeks

        $(document).ready(function(){
            // Handle duration selection
            $('.duration-btn').click(function(){
                $('.duration-btn').removeClass('active');
                $(this).addClass('active');
                selectedDuration = parseInt($(this).data('weeks'));
                $('#duration-confirm').slideDown();
                scrollToBottom();
            });

            // Handle file attachment
            $('#attachButton').click(function(){
                $('#fileInput').click();
            });

            $('#fileInput').change(function(){
                const file = this.files[0];
                if (file) {
                    uploadFile(file);
                }
            });

            // Handle send message
            $('#sendButton').click(sendMessage);
            $('#userInput').keypress(function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendMessage();
                }
            });

            // Handle finish button
            $('#finishButton').click(function(){
                const durationText = selectedDuration === 1 ? 'week' : 'weeks';
                if (confirm(`Ready to generate your complete study guide and ${selectedDuration}-${durationText} schedule?`)) {
                    $(this).prop('disabled', true).text('Generating...');

                    $.ajax({
                        url: '/finish',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ duration_weeks: selectedDuration }),
                        success: function(data) {
                            if (data.status === 'success') {
                                alert('Course created successfully!');
                                window.location.href = '/course/' + encodeURIComponent(data.course_name);
                            } else {
                                alert('Error creating course: ' + data.message);
                                $('#finishButton').prop('disabled', false).html('<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Finish Course');
                            }
                        },
                        error: function() {
                            alert('Error creating course. Please try again.');
                            $('#finishButton').prop('disabled', false).html('<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Finish Course');
                        }
                    });
                }
            });

            function sendMessage() {
                const messageText = $('#userInput').val().trim();
                if (messageText === '') return;

                appendUserMessage(messageText);
                $('#userInput').val('');

                appendLoading();

                $.ajax({
                    url: '/send',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ formdata: messageText }),
                    success: function(data) {
                        removeLoading();
                        appendBotMessage(data.response);
                    },
                    error: function() {
                        removeLoading();
                        appendBotMessage('Sorry, I encountered an error. Please try again.');
                    }
                });
            }

            function uploadFile(file) {
                const formData = new FormData();
                formData.append('pdf_file', file);

                appendUserMessage('ðŸ“Ž Uploaded: ' + file.name);
                appendLoading();

                $.ajax({
                    url: '/load_file',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(data) {
                        removeLoading();
                        if (data.response) {
                            appendBotMessage(data.response);
                        } else if (data.error) {
                            appendBotMessage('Error: ' + data.error);
                        }
                    },
                    error: function(xhr) {
                        removeLoading();
                        const error = xhr.responseJSON?.error || 'Error uploading file';
                        appendBotMessage('Error: ' + error);
                    }
                });
            }

            function appendUserMessage(text) {
                const html = `
                    <div class="message-group user-group">
                        <div class="message-content">
                            <div class="message-bubble user-message">${escapeHtml(text)}</div>
                        </div>
                    </div>
                `;
                $('#messagesArea').append(html);
                scrollToBottom();
            }

            function appendBotMessage(text) {
                const html = `
                    <div class="message-group bot-group">
                        <div class="message-avatar">
                            <img src="{{ url_for('static', filename='icon.png') }}" alt="OLEG">
                        </div>
                        <div class="message-content">
                            <div class="message-bubble bot-message">${escapeHtml(text).replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                `;
                $('#messagesArea').append(html);
                scrollToBottom();
            }

            function appendLoading() {
                const html = `
                    <div class="message-group bot-group loading-group">
                        <div class="message-avatar">
                            <img src="{{ url_for('static', filename='icon.png') }}" alt="OLEG">
                        </div>
                        <div class="message-content">
                            <div class="message-bubble bot-message loading-message">
                                <div class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                $('#messagesArea').append(html);
                scrollToBottom();
            }

            function removeLoading() {
                $('#messagesArea .loading-group').remove();
            }

            function scrollToBottom() {
                const area = $('#messagesArea');
                area.scrollTop(area[0].scrollHeight);
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        });
    </script>
</body>
</html>
